<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è–èª•æŠ½ç±¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; text-align: center; padding: 40px; }
    input, button { font-size: 18px; padding: 8px 14px; }
    #result { margin-top: 24px; font-size: 20px; }
  </style>
</head>
<body>

<h1>ğŸ„ è–èª•æŠ½ç±¤</h1>
<p>è«‹è¼¸å…¥ä½ çš„è™Ÿç¢¼</p>
<input id="codeInput" placeholder="ä¾‹å¦‚ 20506" />
<br><br>
<button id="drawBtn">æ­æ›‰æˆ‘çš„å°ä¸»äºº</button>

<div id="result"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ğŸ”¹ Firebase è¨­å®šï¼ˆä½ çš„å°ˆæ¡ˆï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyALq77Yraym29l8OX2YCLBIBcBve4jo8Dc",
      authDomain: "christmas-draw-c07d6.firebaseapp.com",
      projectId: "christmas-draw-c07d6",
      storageBucket: "christmas-draw-c07d6.firebasestorage.app",
      messagingSenderId: "150938406696",
      appId: "1:150938406696:web:ea9733014831f50029ca1d"
    };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const btn = document.getElementById("drawBtn");
  const result = document.getElementById("result");

  btn.onclick = async () => {
    const code = document.getElementById("codeInput").value.trim();
    if (!code) {
      result.textContent = "è«‹è¼¸å…¥è™Ÿç¢¼";
      return;
    }

    btn.disabled = true;
    result.textContent = "æŠ½ç±¤ä¸­â€¦";

    try {
      // æ‰¾è‡ªå·±
      const selfSnap = await getDocs(
        query(collection(db, "participants"), where("code", "==", code))
      );

      if (selfSnap.empty) {
        result.textContent = "è™Ÿç¢¼ä¸å­˜åœ¨";
        btn.disabled = false;
        return;
      }

      // æ‰¾å¯è¢«æŠ½çš„äººï¼ˆæœªè¢«æŠ½ + ä¸æ˜¯è‡ªå·±ï¼‰
      const candidatesSnap = await getDocs(
        query(collection(db, "participants"), where("drawn", "==", false))
      );

      const candidates = [];
      candidatesSnap.forEach(d => {
        if (d.data().code !== code) {
          candidates.push({ id: d.id, ...d.data() });
        }
      });

      if (candidates.length === 0) {
        result.textContent = "å·²æ²’æœ‰å¯æŠ½çš„äºº";
        btn.disabled = false;
        return;
      }

      // éš¨æ©ŸæŠ½
      const picked = candidates[Math.floor(Math.random() * candidates.length)];

      // é–å®š
      await updateDoc(doc(db, "participants", picked.id), {
        drawn: true
      });

      result.innerHTML = `
        ğŸ ä½ çš„å°ä¸»äººæ˜¯ï¼š<br>
        <strong>${picked.ownerName}</strong><br><br>
        ${picked.info}
      `;

    } catch (e) {
      console.error(e);
      result.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
    }

    btn.disabled = false;
  };
</script>

</body>
</html>
