<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>è–èª•æŠ½ç±¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial; text-align: center; padding: 40px; }
  input, button { font-size: 18px; padding: 8px 14px; }
  #result {
    margin-top: 30px;
    font-size: 22px;
    color: #d63384;
    line-height: 1.6;
  }
</style>
</head>
<body>

<h1>ğŸ„ å°å¤©ä½¿è–èª•æŠ½ç±¤</h1>
<p>è«‹è¼¸å…¥ä½ çš„è™Ÿç¢¼</p>

<input id="codeInput" placeholder="ä¾‹å¦‚ 20506" />
<br><br>
<button id="drawBtn">æ­æ›‰æˆ‘çš„å°ä¸»äºº</button>

<p id="result">è¼¸å…¥è™Ÿç¢¼å¾Œé»æ“ŠæŒ‰éˆ•</p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALq77Yraym29l8OX2YCLBIBcBve4jo8Dc",
  authDomain: "christmas-draw-c07d6.firebaseapp.com",
  projectId: "christmas-draw-c07d6",
  storageBucket: "christmas-draw-c07d6.firebasestorage.app",
  messagingSenderId: "150938406696",
  appId: "1:150938406696:web:ea9733014831f50029ca1d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const btn = document.getElementById("drawBtn");
const result = document.getElementById("result");

btn.onclick = async () => {
  const code = codeInput.value.trim();
  if (!code) {
    result.textContent = "è«‹è¼¸å…¥è™Ÿç¢¼";
    return;
  }

  btn.disabled = true;
  result.textContent = "æŠ½ç±¤ä¸­â€¦";

  try {
    // ğŸ”¹ æ‰¾è‡ªå·±
    const selfSnap = await getDocs(
      query(collection(db, "participants"), where("code", "==", code))
    );

    if (selfSnap.empty) {
      result.textContent = "è™Ÿç¢¼ä¸å­˜åœ¨";
      btn.disabled = false;
      return;
    }

    const self = { id: selfSnap.docs[0].id, ...selfSnap.docs[0].data() };

    // ğŸ”’ å·²æŠ½éå°±ä¸èƒ½å†æŠ½
    if (self.hasDrawn) {
      result.textContent = "ä½ å·²ç¶“æŠ½éäº†ï¼Œä¸èƒ½å†æ¬¡æŠ½ç±¤";
      btn.disabled = false;
      return;
    }

    // ğŸ”¹ æ‰¾å¯è¢«æŠ½çš„äºº
    const candidatesSnap = await getDocs(
      query(collection(db, "participants"), where("drawn", "==", false))
    );

    const candidates = [];
    candidatesSnap.forEach(d => {
      if (d.data().code !== code) {
        candidates.push({ id: d.id, ...d.data() });
      }
    });

    if (candidates.length === 0) {
      result.textContent = "å·²æ²’æœ‰å¯æŠ½çš„äºº";
      btn.disabled = false;
      return;
    }

    const picked = candidates[Math.floor(Math.random() * candidates.length)];

    // âœ… åŒæ™‚é–å…©å€‹äºº
    await updateDoc(doc(db, "participants", picked.id), { drawn: true });
    await updateDoc(doc(db, "participants", self.id), { hasDrawn: true });

    result.innerHTML = `
      ğŸ„ ä½ æ˜¯å°å¤©ä½¿ï¼š<strong>${self.code}</strong><br><br>
      ğŸ ä½ çš„å°ä¸»äººæ˜¯ï¼š<br>
      <strong>${picked.ownerName}</strong><br><br>
      ${picked.info}
    `;
  } catch (e) {
    console.error(e);
    result.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
  }

  btn.disabled = false;
};
</script>

</body>
</html>

